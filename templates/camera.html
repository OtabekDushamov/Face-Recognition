<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Scan - Verify your identity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --error: #dc2626;
            --success: #16a34a;
            --warning: #d97706;
        }
        
        body {
            background-color: #f3f4f6;
            color: #111827;
            min-height: 100vh;
            transition: background-color 0.3s;
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #111827;
                color: #f3f4f6;
            }
            
            .card {
                background-color: #1f2937 !important;
                border-color: #374151 !important;
            }
            
            .btn-secondary {
                background-color: #374151 !important;
                color: #f3f4f6 !important;
            }
        }
        
        .card {
            background-color: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            background-color: #000;
        }
        
        .video-container video, .video-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 10;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            outline: none;
        }
        
        .btn:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #111827;
        }
        
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        
        .badge {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            margin-top: 1rem;
            display: inline-flex;
            align-items: center;
        }
        
        .badge-success {
            background-color: #dcfce7;
            color: var(--success);
        }
        
        .badge-error {
            background-color: #fee2e2;
            color: var(--error);
        }
        
        .badge-warning {
            background-color: #fef3c7;
            color: var(--warning);
        }
        
        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-banner {
            background-color: var(--error);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="flex flex-col items-center p-4">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-1">Face Scan</h1>
        <p class="text-gray-500 dark:text-gray-400">Verify your identity</p>
    </header>
    
    <main class="w-full max-w-3xl">
        <div class="card rounded-2xl p-6 w-full">
            <div id="errorBanner" class="error-banner hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <span id="errorMessage"></span>
            </div>

            <!-- Staff Selection -->
            <div class="mb-6">
                <label for="staffSelect" class="block text-sm font-medium mb-2">Select Staff Member</label>
                <select id="staffSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                    <option value="">Choose a staff member...</option>
                </select>
            </div>
            
            <!-- Live Camera on Top -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3 text-center">Live Camera</h3>
                <div class="video-container rounded-xl overflow-hidden relative">
                    <video id="video" playsinline autoplay muted class="w-full h-full object-cover"></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    
                    <div id="overlay" class="overlay">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <p class="text-center">Allow camera access to continue</p>
                        <small class="text-gray-300 mt-2">Requires HTTPS or localhost</small>
                    </div>
                </div>
            </div>

            <!-- Two Panels Below -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Left Panel - Captured Photo -->
                <div>
                    <h3 class="text-lg font-medium mb-3 text-center">Captured Photo</h3>
                    <div class="aspect-square bg-gray-100 dark:bg-gray-800 rounded-xl overflow-hidden relative">
                        <canvas id="capturedPhotoCanvas" class="w-full h-full object-cover hidden"></canvas>
                        <div id="capturedPhotoPlaceholder" class="w-full h-full flex flex-col items-center justify-center text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <p class="text-center text-sm">Click capture to take photo</p>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - Staff Photo -->
                <div>
                    <h3 class="text-lg font-medium mb-3 text-center">Staff Photo</h3>
                    <div class="aspect-square bg-gray-100 dark:bg-gray-800 rounded-xl overflow-hidden relative">
                        <img id="staffPhoto" class="w-full h-full object-cover hidden" alt="Staff Photo">
                        <div id="staffPhotoPlaceholder" class="w-full h-full flex flex-col items-center justify-center text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <p class="text-center text-sm">Select staff member above</p>
                        </div>
                        <div id="staffInfo" class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white p-3 hidden">
                            <p id="staffName" class="font-medium"></p>
                            <p id="staffDepartment" class="text-sm opacity-90"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex flex-wrap justify-center gap-3 mb-4">
                <button id="captureBtn" class="btn btn-secondary px-6 py-3" aria-label="Capture photo">
                    üì∏ Capture
                </button>
                <button id="retakeBtn" class="btn btn-secondary px-6 py-3 hidden" aria-label="Retake photo">
                    üîÑ Retake
                </button>
                <button id="verifyBtn" class="btn btn-primary px-8 py-3" disabled aria-label="Verify face">
                    üîç Verify Face
                </button>
            </div>
            
            <div id="statusArea" class="min-h-10">
                <!-- Status messages will appear here -->
            </div>
            
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-4 text-center">
                Your photo is used only for verification and not stored.
            </p>
        </div>
    </main>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedPhotoCanvas = document.getElementById('capturedPhotoCanvas');
        const capturedPhotoPlaceholder = document.getElementById('capturedPhotoPlaceholder');
        const staffSelect = document.getElementById('staffSelect');
        const staffPhoto = document.getElementById('staffPhoto');
        const staffPhotoPlaceholder = document.getElementById('staffPhotoPlaceholder');
        const staffInfo = document.getElementById('staffInfo');
        const staffName = document.getElementById('staffName');
        const staffDepartment = document.getElementById('staffDepartment');
        const overlay = document.getElementById('overlay');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const verifyBtn = document.getElementById('verifyBtn');
        const statusArea = document.getElementById('statusArea');
        const errorBanner = document.getElementById('errorBanner');
        const errorMessage = document.getElementById('errorMessage');
        
        // State
        let stream = null;
        let photoTaken = false;
        let selectedStaff = null;
        let staffList = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            startCamera();
            loadStaffList();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            captureBtn.addEventListener('click', captureFrame);
            retakeBtn.addEventListener('click', retakePhoto);
            verifyBtn.addEventListener('click', verifyFace);
            staffSelect.addEventListener('change', onStaffSelect);
        }
        
        // Staff loading and selection
        async function loadStaffList() {
            try {
                const response = await fetch('/verify/api/staff/');
                const data = await response.json();
                
                if (data.success) {
                    staffList = data.staff_members;
                    populateStaffSelect();
                } else {
                    showError('Failed to load staff list');
                }
            } catch (err) {
                console.error('Error loading staff:', err);
                showError('Failed to load staff list');
            }
        }
        
        function populateStaffSelect() {
            staffSelect.innerHTML = '<option value="">Choose a staff member...</option>';
            
            staffList.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.staff_id;
                option.textContent = `${staff.name} - ${staff.department || 'No Department'}`;
                staffSelect.appendChild(option);
            });
            
            // Check if there's a user_id in URL and select it
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            if (userId) {
                staffSelect.value = userId;
                onStaffSelect();
            }
        }
        
        async function onStaffSelect() {
            const staffId = staffSelect.value;
            
            if (!staffId) {
                // Clear staff photo
                staffPhoto.classList.add('hidden');
                staffPhotoPlaceholder.classList.remove('hidden');
                staffInfo.classList.add('hidden');
                selectedStaff = null;
                updateVerifyButton();
                return;
            }
            
            try {
                const response = await fetch(`/verify/api/staff/${staffId}/`);
                const data = await response.json();
                
                if (data.success) {
                    selectedStaff = data.staff;
                    displayStaffPhoto();
                    updateVerifyButton();
                } else {
                    showError('Failed to load staff details');
                }
            } catch (err) {
                console.error('Error loading staff details:', err);
                showError('Failed to load staff details');
            }
        }
        
        function displayStaffPhoto() {
            if (!selectedStaff) return;
            
            // Set staff info
            staffName.textContent = selectedStaff.name;
            staffDepartment.textContent = selectedStaff.department || selectedStaff.position || '';
            
            // Check if staff has a photo
            if (selectedStaff.has_photo && selectedStaff.photo_url) {
                // Hide placeholder and show photo
                staffPhotoPlaceholder.classList.add('hidden');
                staffPhoto.classList.remove('hidden');
                staffInfo.classList.remove('hidden');
                
                // Set staff photo URL
                staffPhoto.src = selectedStaff.photo_url;
                staffPhoto.onerror = () => {
                    // If photo fails to load, show placeholder
                    staffPhoto.classList.add('hidden');
                    staffPhotoPlaceholder.classList.remove('hidden');
                    staffInfo.classList.add('hidden');
                };
            } else {
                // No photo available, show placeholder
                staffPhoto.classList.add('hidden');
                staffPhotoPlaceholder.classList.remove('hidden');
                staffInfo.classList.add('hidden');
            }
        }
        
        function updateVerifyButton() {
            verifyBtn.disabled = !photoTaken || !selectedStaff;
        }
        
        // Camera functions
        async function startCamera() {
            try {
                // Check if we're in a secure context
                if (!isSecureContext()) {
                    showError('Camera access requires HTTPS or localhost.');
                    return;
                }
                
                // Get camera stream
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" },
                    audio: false
                });
                
                // Set video source
                video.srcObject = stream;
                
                // Hide overlay when video starts playing
                video.addEventListener('playing', () => {
                    overlay.classList.add('hidden');
                });
                
            } catch (err) {
                console.error('Camera error:', err);
                handleCameraError(err);
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }
        
        function handleCameraError(err) {
            let message = 'Could not access camera.';
            
            if (err.name === 'NotAllowedError') {
                message = 'Camera permission denied. Please allow access to continue.';
            } else if (err.name === 'NotFoundError') {
                message = 'No camera found.';
            } else if (err.name === 'NotReadableError') {
                message = 'Camera is already in use by another application.';
            }
            
            showError(message);
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorBanner.classList.remove('hidden');
        }
        
        function hideError() {
            errorBanner.classList.add('hidden');
        }
        
        // Photo capture functions
        function captureFrame() {
            if (!stream) return;
            
            // Set canvas dimensions to match video
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            capturedPhotoCanvas.width = videoWidth;
            capturedPhotoCanvas.height = videoHeight;
            
            // Draw current video frame to main canvas (for upload)
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, videoWidth, videoHeight);
            
            // Draw to captured photo canvas for display
            const capturedCtx = capturedPhotoCanvas.getContext('2d');
            capturedCtx.drawImage(video, 0, 0, videoWidth, videoHeight);
            
            // Update UI state
            photoTaken = true;
            capturedPhotoPlaceholder.classList.add('hidden');
            capturedPhotoCanvas.classList.remove('hidden');
            captureBtn.classList.add('hidden');
            retakeBtn.classList.remove('hidden');
            updateVerifyButton();
        }
        
        function retakePhoto() {
            // Clear canvas
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const capturedCtx = capturedPhotoCanvas.getContext('2d');
            capturedCtx.clearRect(0, 0, capturedPhotoCanvas.width, capturedPhotoCanvas.height);
            
            // Update UI state
            photoTaken = false;
            capturedPhotoPlaceholder.classList.remove('hidden');
            capturedPhotoCanvas.classList.add('hidden');
            captureBtn.classList.remove('hidden');
            retakeBtn.classList.add('hidden');
            updateVerifyButton();
            
            // Clear any status messages
            clearStatus();
        }
        
        // Verification functions
        async function verifyFace() {
            if (!photoTaken || !selectedStaff) return;
            
            // Show loading state
            setStatus('loading', 'Verifying face...');
            
            try {
                // Convert canvas to JPEG blob
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/jpeg', 0.9);
                });
                
                // Prepare form data
                const formData = new FormData();
                formData.append('photo', blob, 'face_verification.jpg');
                
                // Prepare headers
                const headers = {
                    'Accept': 'application/json'
                };
                
                // Add CSRF token if available
                const csrfToken = getCsrfToken();
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }
                
                // Build URL with selected staff ID
                const url = `/verify/api/verify/?user_id=${encodeURIComponent(selectedStaff.staff_id)}`;
                
                // Send to server
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                
                const result = await response.json();
                
                // Show result with enhanced messaging
                if (result.success) {
                    const confidence = result.confidence_score ? ` (${Math.round(result.confidence_score * 100)}%)` : '';
                    setStatus('success', `‚úÖ MATCH! Welcome, ${selectedStaff.name}${confidence}`);
                } else {
                    setStatus('error', result.message || '‚ùå NO MATCH - Face verification failed');
                }
                
            } catch (err) {
                console.error('Verification error:', err);
                setStatus('error', 'Verification failed. Please try again.');
            }
        }
        
        // Status helpers
        function setStatus(type, message) {
            // Clear previous status
            clearStatus();
            
            // Create new status element
            const statusEl = document.createElement('div');
            statusEl.className = `badge badge-${type}`;
            
            if (type === 'loading') {
                statusEl.innerHTML = `
                    <div class="spinner mr-2"></div>
                    <span>${message}</span>
                `;
            } else {
                statusEl.textContent = message;
            }
            
            statusArea.appendChild(statusEl);
        }
        
        function clearStatus() {
            statusArea.innerHTML = '';
        }
        
        // Utility functions
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            
            return cookieValue || null;
        }
        
        function isSecureContext() {
            return window.isSecureContext;
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>
</html>